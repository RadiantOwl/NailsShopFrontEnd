<!DOCTYPE html>
<html>

<head>
    <title>CareNail | Запись</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="keywords" content="nails, site, website" />
    <meta name="description" content="Лучшие ноготочки в мире" />
    <link href="css/record.css" rel="stylesheet" type="text/css" />
    <link href="image/icon.ico" rel="shortcut icon" type="image/x-icon" />
    <script>

      var xhr = new XMLHttpRequest();

      // 2. Конфигурируем его: GET-запрос на URL 'phones.json'
      xhr.open('GET', 'https://localhost:44374/api/procedures', false);

      // 3. Отсылаем запрос
      xhr.send();

      // 4. Если код ответа сервера не 200, то это ошибка
      if (xhr.status != 200) {
          // обработать ошибку
          alert(xhr.status + ': ' + xhr.statusText); // пример вывода: 404: Not Found
      } else {
          // вывести результат
          var data = JSON.parse(xhr.responseText); // responseText -- текст ответа.
      }


        function sendJSON() {
          // с помощью jQuery обращаемся к элементам на странице по их именам
          let first_name = document.querySelector('#first_name');
          let second_name = document.querySelector('#second_name');
          let email = document.querySelector('#email');
          let phone_num = document.querySelector('#phone_num');
          let date = document.querySelector('#date');
 
            let result = document.querySelector('.result');



          
          let xhr = new XMLHttpRequest();
          let url = "https://localhost:44374/api/customers";
          xhr.open("POST", url, true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              result.innerHTML = this.responseText;
            }
          };
          
          var data = JSON.stringify
          ({ "first_name": first_name.value, "second_name": second_name.value, "email": email.value, "phone_num": phone_num.value, "date": date.value});
          xhr.send(data);
          console.log(data);
          //после отправки данных клиента вызываем функцию
          //эта функция найдёт последнего отправленного клиента и отправит его айди в таблицу с процедурами

         // sendProcedures();
          
        }

        function sendProcedures()
        {
            let id_procedure = document.querySelector("#id_procedure");
            let xhr1 = new XMLHttpRequest();
          let url1 = "https://localhost:44374/api/appointments"; //вызываем нашу таблицу с процедурами и клиентами, куда мы будем записывать их айдшники
          xhr1.open("POST", url1, true);
          xhr1.setRequestHeader("Content-Type", "application/json");
          xhr1.onreadystatechange = function () {
            if (xhr1.readyState === 4 && xhr1.status === 200) {
              result.innerHTML = this.responseText;
            }
          };

           // var xhr2 = new XMLHttpRequest(); 
            xhr2.open('GET', 'https://localhost:44374/api/customers', false); //загружаем данные из таблицы с клиентами
            xhr2.send();
            if (xhr2.status != 200) {
                alert(xhr2.status + ': ' + xhr2.statusText);
            } 
            else {
                var data2 = JSON.parse(xhr2.responseText);
            }
            var id_customer = data2[(data2.length)-1].id_customer; //получаем значение айдишника клиента, которого только что отправили
          var data1 = JSON.stringify
          ({"id_customer":id_customer.value, "id_procedure":id_procedure.value});
          xhr1.send(data1);
            alert("Вы успешно отправили заявку.")
        }
      //  function loadList() {



            
            


      </script>
</head>

<body>
    <div id="page-wrap">
        <header>
            <!-- ШАПКА САЙТА -->
            <div id="HeadMenu1">
                <div>
                    <a href="price.html">Услуги и цены</a>
                </div>
                <div>
                    <a href="galery.html">Портфолио</a>
                </div>
                <div>
                    <a href="stocks.html">Акции</a>
                </div>
                <div>
                    <a href="about.html">О нас</a>
                </div>
            </div>
            <div id="LogoMenu">
                <div>
                    <a href="index.html">CareNail</a>
                </div>
            </div>
            <div id="HeadMenu2">
                <div id="empty"></div>
                <a class="user" href="registration.html"> Записаться на прием</a>
            </div>
        </header>
        <!-- НАПОЛНЕНИЕ -->
        <div id="mainForm" style="display: hidden;">
            <p><b>Имя:</b><br>
                <input type="text" id="first_name" size="40" placeholder="Имя">
            </p>
            <p><b>Фамилия:</b><br>
                <input type="text" id="second_name" size="40" placeholder="Фамилия">
            </p>
            <p><b>Email:</b><br>
                <input type="text" id="email" size="40" placeholder="E-mail адрес">
            </p>
            <p><b>Телефон:</b><br>
                <input type="text" id="phone_num" size="40" placeholder="Номер телефона">
            </p>
            <p><b>Дата:</b><br>
                <input type="date" id="date" size="40" placeholder="Дата записи">
            </p>
            
             <button onclick="sendJSON()">Записаться</button><br>
             <select name = "id_procedure" id="id_procedure"  size="7">


             </div>
        </div>
       <div>
         <script>


        var mainContainer1 = document.getElementById("id_procedure");
        for (var i = 0; i < data.length; i++) {
          var anchor = document.createElement("option");
          anchor.innerText = data[i].procedure_name + " — " + data[i].procedure_price + "₽";
          mainContainer1.appendChild(anchor);
        }
        
        


  </script>

       </div>
    </div>
    <footer>
        <div id="FootLogo">
            <div>
                <a href="index.html">CareNail</a>
            </div>
        </div>
        <div id="FootContent">
            <div>
                <a href="price.html">Услуги и цены</a>
            </div>
            <div>
                <a href="galery.html">Портфолио</a>
            </div>
            <div>
                <a href="stocks.html">Акции</a>
            </div>
            <div>
                <a href="about.html">О нас</a>
            </div>
        </div>
        <div id="FootSites">
            <div>
                <a href="#"><img src="image/VK.png"></a>
            </div>
            <div>
                <a href="#"><img src="image/tele.png"></a>
            </div>
            <div>
                <a href="#"><img src="image/inst.png"></a>
            </div>
        </div>
        </div>
    </footer>
</body>
</html>